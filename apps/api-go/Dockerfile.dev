# Development Dockerfile with hot reloading support
# This image includes Go compiler and Air for hot reloading
FROM golang:1.25-alpine

WORKDIR /app

# Install build dependencies and Air
RUN apk add --no-cache git ca-certificates tzdata nodejs npm wget && \
    go install github.com/air-verse/air@latest && \
    go install github.com/swaggo/swag/cmd/swag@latest && \
    npm install -g tsx && \
    npm cache clean --force

# Copy go mod files for dependency caching
COPY apps/api-go/go.mod apps/api-go/go.sum ./

# Download dependencies
RUN go mod download

# Copy source code (will be overridden by volume mount in docker-compose)
COPY apps/api-go/ .

# Copy config files
COPY apps/api-go/config ./config

# Build renderer package (for dev, we'll mount it as volume, but copy for initial setup)
# Note: In dev mode, renderer is built on host and mounted via volume
# This ensures the renderer is available even if volume mount fails
RUN mkdir -p /app/renderer/dist-ssr

# Return to app directory
WORKDIR /app

# Create directories for volumes
RUN mkdir -p /app/uploads /app/layouts /app/tmp

# Generate Swagger docs (will be regenerated by Air on changes)
RUN swag init -g cmd/server/main.go -o docs || true

# Default command runs Air for hot reloading
# Source code is mounted as volume, so changes trigger rebuilds
CMD ["air", "-c", "/app/.air.toml"]

