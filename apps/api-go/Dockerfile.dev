# Development Dockerfile with hot reloading support
# This image includes Go compiler and Air for hot reloading
FROM golang:1.25-alpine

WORKDIR /app

# Install build dependencies and Air
RUN apk add --no-cache git ca-certificates tzdata nodejs npm wget && \
    go install github.com/air-verse/air@latest && \
    go install github.com/swaggo/swag/cmd/swag@latest

# Copy go mod files for dependency caching
COPY apps/api-go/go.mod apps/api-go/go.sum ./

# Download dependencies
RUN go mod download

# Copy source code (will be overridden by volume mount in docker-compose)
COPY apps/api-go/ .

# Copy config files
COPY apps/api-go/config ./config

# Copy builder template engine files
COPY apps/builder/src/template-engine /app/builder/template-engine

# Install Node.js dependencies for template engine
WORKDIR /app/builder/template-engine
RUN npm install --production

# Return to app directory
WORKDIR /app

# Create directories for volumes
RUN mkdir -p /app/uploads /app/layouts /app/tmp

# Generate Swagger docs (will be regenerated by Air on changes)
RUN swag init -g cmd/server/main.go -o docs || true

# Default command runs Air for hot reloading
# Source code is mounted as volume, so changes trigger rebuilds
CMD ["air", "-c", "/app/.air.toml"]

