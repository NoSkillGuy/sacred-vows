services:
  api-go:
    build:
      context: .
      dockerfile: ./apps/api-go/Dockerfile
    env_file:
      - ./apps/api-go/.env
    ports:
      - "3000:3000"
    environment:
      APP_ENV: ${APP_ENV:-local}
      GCP_PROJECT_ID: ${GCP_PROJECT_ID:-test-project}
      FIRESTORE_DATABASE: ${FIRESTORE_DATABASE:-(default)}
      FIRESTORE_EMULATOR_HOST: ${FIRESTORE_EMULATOR_HOST:-firestore-emulator:8080}
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-min-32-chars-long-for-security-change-me}
      REFRESH_TOKEN_HMAC_KEYS: ${REFRESH_TOKEN_HMAC_KEYS:-[{"id":1,"key_b64":"dGVzdC1rZXktZm9yLWRldmVsb3BtZW50LW9ubHktMzItY2hhcnMtbG9uZw=="}]}
      REFRESH_TOKEN_HMAC_ACTIVE_KEY_ID: ${REFRESH_TOKEN_HMAC_ACTIVE_KEY_ID:-1}
      PORT: 3000
      LAYOUTS_DIR: /app/layouts
      UPLOAD_PATH: /app/uploads
      FRONTEND_URL: http://localhost:5173
      # Google OAuth variables are loaded from env_file (apps/api-go/.env)
      # They are not set here to allow env_file to provide the values
      GOOGLE_REDIRECT_URI: http://localhost:3000/api/auth/google/callback
      # R2/MinIO configuration for local development (publishing)
      R2_ENDPOINT: ${R2_ENDPOINT:-http://minio:9000}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:-minioadmin}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:-minioadmin}
      R2_BUCKET: ${R2_BUCKET:-sacred-vows-published-local}
      PUBLIC_ASSETS_R2_BUCKET: ${PUBLIC_ASSETS_R2_BUCKET:-sacred-vows-public-assets-local}
      PUBLIC_ASSETS_CDN_URL: ${PUBLIC_ASSETS_CDN_URL:-http://localhost:9000/sacred-vows-public-assets-local}
      # S3/MinIO configuration for assets storage (local development)
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_PUBLIC_ENDPOINT: ${S3_PUBLIC_ENDPOINT:-http://localhost:9000}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-minioadmin}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-minioadmin}
      S3_ASSETS_BUCKET: ${S3_ASSETS_BUCKET:-sacred-vows-assets-local}
      S3_REGION: ${S3_REGION:-us-east-1}
    depends_on:
      firestore-emulator:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - ./apps/builder/layouts:/app/layouts
      - api_go_uploads:/app/uploads
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  firestore-emulator:
    image: eclipse-temurin:21-jre-jammy
    working_dir: /app
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y --no-install-recommends curl ca-certificates &&
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash - &&
        apt-get install -y --no-install-recommends nodejs &&
        apt-get clean &&
        rm -rf /var/lib/apt/lists/* &&
        npm install -g firebase-tools &&
        firebase emulators:start --only firestore,ui --project test-project
      "
    ports:
      - "8080:8080"  # Firestore emulator
      - "4000:4000"  # Firebase Emulator UI
    environment:
      GCLOUD_PROJECT: ${GCP_PROJECT_ID:-test-project}
    volumes:
      - ./firebase.json:/app/firebase.json:ro
      - firestore_data:/root/.cache/firebase/emulators
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4000"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"  # S3 API
      - "9001:9001"  # Web Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

volumes:
  api_go_uploads:
  minio_data:
  firestore_data:

