services:
  api-go:
    build:
      context: ./apps/api-go
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      GCP_PROJECT_ID: ${GCP_PROJECT_ID:-test-project}
      FIRESTORE_DATABASE: ${FIRESTORE_DATABASE:-(default)}
      FIRESTORE_EMULATOR_HOST: ${FIRESTORE_EMULATOR_HOST:-firestore-emulator:8080}
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-min-32-chars-long-for-security}
      PORT: 3000
      LAYOUTS_DIR: /app/layouts
      UPLOAD_PATH: /app/uploads
      FRONTEND_URL: http://localhost:5173
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: http://localhost:3000/api/auth/google/callback
    depends_on:
      firestore-emulator:
        condition: service_healthy
    volumes:
      - ./apps/builder/layouts:/app/layouts
      - api_go_uploads:/app/uploads
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  firestore-emulator:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    command: gcloud beta emulators firestore start --host-port=0.0.0.0:8080
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  api_go_uploads:

