services:
  api-go:
    build:
      context: .
      dockerfile: ./apps/api-go/Dockerfile.dev
    # env_file is optional - if .env.docker doesn't exist, environment variables below will be used
    env_file:
      - ./apps/api-go/.env.docker
    ports:
      - "3000:3000"
    environment:
      APP_ENV: ${APP_ENV:-local}
      GCP_PROJECT_ID: ${GCP_PROJECT_ID:-test-project}
      FIRESTORE_DATABASE: ${FIRESTORE_DATABASE:-(default)}
      FIRESTORE_EMULATOR_HOST: ${FIRESTORE_EMULATOR_HOST:-firestore-emulator:8080}
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-min-32-chars-long-for-security-change-me}
      REFRESH_TOKEN_HMAC_KEYS: ${REFRESH_TOKEN_HMAC_KEYS:-[{"id":1,"key_b64":"dGVzdC1rZXktZm9yLWRldmVsb3BtZW50LW9ubHktMzItY2hhcnMtbG9uZw=="}]}
      REFRESH_TOKEN_HMAC_ACTIVE_KEY_ID: ${REFRESH_TOKEN_HMAC_ACTIVE_KEY_ID:-1}
      PORT: 3000
      LAYOUTS_DIR: /app/layouts
      UPLOAD_PATH: /app/uploads
      FRONTEND_URL: http://localhost:5173
      # Google OAuth variables are loaded from env_file (apps/api-go/.env.docker)
      # They are not set here to allow env_file to provide the values
      GOOGLE_REDIRECT_URI: http://localhost:3000/api/auth/google/callback
      # R2/MinIO configuration for local development (publishing)
      R2_ENDPOINT: ${R2_ENDPOINT:-http://minio:9000}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:-minioadmin}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:-minioadmin}
      R2_BUCKET: ${R2_BUCKET:-sacred-vows-published-local}
      PUBLIC_ASSETS_R2_BUCKET: ${PUBLIC_ASSETS_R2_BUCKET:-sacred-vows-public-assets-local}
      PUBLIC_ASSETS_CDN_URL: ${PUBLIC_ASSETS_CDN_URL:-http://localhost:9000/sacred-vows-public-assets-local}
      # S3/MinIO configuration for assets storage (local development)
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_PUBLIC_ENDPOINT: ${S3_PUBLIC_ENDPOINT:-http://localhost:9000}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-minioadmin}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-minioadmin}
      S3_ASSETS_BUCKET: ${S3_ASSETS_BUCKET:-sacred-vows-assets-local}
      S3_REGION: ${S3_REGION:-us-east-1}
      # OpenTelemetry (development)
      # Traces go to Tempo, metrics go to OpenTelemetry Collector
      OTEL_ENABLED: ${OTEL_ENABLED:-true}
      OTEL_EXPORTER_OTLP_ENDPOINT: http://tempo:4318
      OTEL_EXPORTER_OTLP_PROTOCOL: ${OTEL_EXPORTER_OTLP_PROTOCOL:-http}
      OTEL_METRICS_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_METRICS_EXPORTER_OTLP_PROTOCOL: grpc
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-sacred-vows-api}
      OTEL_RESOURCE_ATTRIBUTES: deployment.environment=${APP_ENV:-local}
      # Snapshot renderer configuration
      SNAPSHOT_RENDERER_SCRIPT: ${SNAPSHOT_RENDERER_SCRIPT:-/app/builder/src/template-engine/src/renderPublishedHTML.ts}
      SNAPSHOT_RENDERER_NODE: ${SNAPSHOT_RENDERER_NODE:-tsx}
    depends_on:
      firestore-emulator:
        condition: service_healthy
      minio:
        condition: service_healthy
      tempo:
        condition: service_started
    volumes:
      - ./apps/builder/layouts:/app/layouts
      - api_go_uploads:/app/uploads
      # Mount source code for hot reloading - Air will watch for changes
      - ./apps/api-go:/app:rw
      # Mount builder code so api-go can access the snapshot renderer script
      - ./apps/builder:/app/builder:ro
      # Exclude build directories from volume to avoid conflicts
      - /app/tmp
      - /app/bin
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  builder:
    build:
      context: .
      dockerfile: ./apps/builder/Dockerfile.dev
    # env_file is optional - if .env.docker doesn't exist, environment variables below will be used
    env_file:
      - ./apps/builder/.env.docker
    ports:
      - "5173:5173"
    environment:
      # Pass Vite environment variables from env_file
      # Vite reads these at dev server start
      # Use relative path /api so browser requests go through Vite proxy
      # The proxy target is set separately in vite.config.ts
      VITE_API_URL: ${VITE_API_URL:-/api}
      # Proxy target for Vite dev server (used by Node.js, can use Docker service names)
      VITE_API_PROXY_TARGET: ${VITE_API_PROXY_TARGET:-http://api-go:3000}
      VITE_PUBLIC_ASSETS_CDN_URL: ${VITE_PUBLIC_ASSETS_CDN_URL:-http://localhost:9000/sacred-vows-public-assets-local}
      VITE_ENABLE_ASSET_CACHING: ${VITE_ENABLE_ASSET_CACHING:-true}
      VITE_OTEL_ENABLED: ${VITE_OTEL_ENABLED:-true}
      # Use localhost since browser connects directly (tempo is exposed on port 4318)
      VITE_OTEL_EXPORTER_OTLP_ENDPOINT: ${VITE_OTEL_EXPORTER_OTLP_ENDPOINT:-http://localhost:4318}
      VITE_OTEL_SERVICE_NAME: ${VITE_OTEL_SERVICE_NAME:-sacred-vows-web}
      VITE_OTEL_SERVICE_VERSION: ${VITE_OTEL_SERVICE_VERSION:-unknown}
      VITE_OTEL_DEPLOYMENT_ENVIRONMENT: ${VITE_OTEL_DEPLOYMENT_ENVIRONMENT:-local}
      VITE_OTEL_TRACES_SAMPLER_RATIO: ${VITE_OTEL_TRACES_SAMPLER_RATIO:-0.01}
    depends_on:
      api-go:
        condition: service_healthy
      minio:
        condition: service_healthy
      tempo:
        condition: service_started
    volumes:
      # Mount source code for hot reloading - Vite will watch for changes
      - ./apps/builder:/app:rw
      # Exclude node_modules and dist from volume to avoid conflicts
      # Use anonymous volume to preserve node_modules in container
      - /app/node_modules
      - /app/dist
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  firestore-emulator:
    build:
      context: .
      dockerfile: ./docker/firestore-emulator/Dockerfile
    ports:
      - "8080:8080"  # Firestore emulator
      - "4000:4000"  # Firebase Emulator UI
    environment:
      GCLOUD_PROJECT: ${GCP_PROJECT_ID:-test-project}
    volumes:
      - ./firebase.json:/app/firebase.json:ro
      - firestore_data:/root/.cache/firebase/emulators
    command: ["sh", "-c", "firebase emulators:start --only firestore,ui --project ${GCLOUD_PROJECT:-test-project}"]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"  # S3 API
      - "9001:9001"  # Web Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  tempo:
    image: grafana/tempo:latest
    command: ["-config.file=/etc/tempo/tempo.yml"]
    ports:
      - "4317:4317"  # OTLP gRPC
      - "4318:4318"  # OTLP HTTP
      - "3200:3200"  # Tempo UI
    volumes:
      - ./docker/tempo/tempo.yml:/etc/tempo/tempo.yml:ro
      - tempo_data:/var/tempo
    # Note: Healthcheck removed for distroless container compatibility
    # Tempo starts quickly and services use service_started condition instead

  prometheus:
    image: prom/prometheus:latest
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-remote-write-receiver'  # Enable remote write receiver for Tempo
    ports:
      - "9090:9090"  # Prometheus UI
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    depends_on:
      tempo:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5

  otel-collector:
    image: otel/opentelemetry-collector:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    ports:
      - "4317:4317"  # OTLP gRPC (backend)
      - "4318:4318"  # OTLP HTTP (frontend)
      - "8889:8889"  # Prometheus metrics endpoint
    volumes:
      - ./docker/otel-collector/config.yaml:/etc/otel-collector-config.yaml:ro
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8889/metrics"]
      interval: 10s
      timeout: 5s
      retries: 5

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3001:3000"  # Grafana UI (different from API port 3000)
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: "Viewer"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    depends_on:
      tempo:
        condition: service_started
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  api_go_uploads:
  minio_data:
  firestore_data:
  tempo_data:
  prometheus_data:
  grafana_data:

